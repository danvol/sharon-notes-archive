---
title: 第3章 命令行脚本基础
hidden: true
---

# 第3章 命令行脚本基础

- [x] 3.1 创建命令行脚本
- [x] 3.2 [脚本的常见语句与命令](#脚本的常见语句与命令)
  - 3.2.1 清除命令shell窗口
  - 3.2.2 为脚本添加注释
  - 3.2.3 管理文字的显示方式与命令回显方式
  - 3.2.5 设置控制台窗口的标题与颜色
- [x] 3.3 [向脚本传递参数](#向脚本传递参数)
- [x] 3.4 [熟悉变量](#熟悉变量)
- [x] 3.5 [在脚本中使用变量](#在脚本中使用变量)
  - 3.5.1 变量命名
  - 3.5.2 设置变量值
  - 3.5.3 替换变量值
  - 3.5.4 变量作用范围局部化
- [x] 3.6 [使用数学表达式](#使用数学表达式)
  - 3.6.1 使用算术运算符与赋值运算符
  - 3.6.2 理解运算符的优先级
  - 3.6.3 模拟指数操作
- [x] 3.7 [命令行选择语句](#命令行选择语句)
  - 3.7.1 使用if语句
  - 3.7.2 使用if not语句
  - 3.7.3 使用if defined与if not defined语句
  - 3.7.4 使用嵌套的if语句
  - 3.7.5 在if语句中进行比较
- [x] 3.8 [命令行迭代语句](#命令行迭代语句)
  - 3.8.1 迭代的基础
  - 3.8.2 [遍历一系列值](#遍历一系列值)
  - 3.8.3 [在成组的文件中迭代执行](#在成组的文件中迭代执行)
  - 3.8.4 [在目录中迭代执行](#在目录中迭代执行)
  - 3.8.5 [分析文件的内容与输出](#分析文件的内容与输出)
- [x] 3.9 [创建子程序与过程](#创建子程序与过程)
  - 3.9.1 使用子程序
  - 3.9.2 使用过程

## 脚本的常见语句与命令

```shell
# 注释
rem

# 关闭回显
echo off
# 输出空行
echo.
# 当前命令不回显
@echo off
```

**设置控制台窗口的标题与颜色：**

```shell
# 设置标题
title <标题>
# 设置颜色，第一个数字背景色，第二个数字文字色
color 21
# 恢复默认颜色
color
```

**窗口颜色代码：**

| 代码 | 颜色   | 代码 | 颜色     |
| ---- | ------ | ---- | -------- |
| 0    | 黑色   | 8    | 灰色     |
| 1    | 蓝色   | 9    | 淡蓝色   |
| 2    | 绿色   | A    | 淡绿色   |
| 3    | 浅绿色 | B    | 浅水绿色 |
| 4    | 红色   | C    | 浅红色   |
| 5    | 紫色   | D    | 淡紫色   |
| 6    | 黄色   | E    | 淡黄色   |
| 7    | 白色   | F    | 亮白色   |

## 向脚本传递参数

- `%0` 命令名称
- `%*` 所有参数 `%1~%n`

- `shift /n` 丢弃第 n 位，后面的左移，默认 0

## 熟悉变量

```shell
set foo=bar
# 删除
set foo=
```

## 在脚本中使用变量

大小写不敏感，建议小写字母开头的驼峰命名

> echo 变量需要转义两次，如输出 `2^3`：
>
> ```shell
> set foo=2^^^^3
> echo %foo%
> ```

```shell
# 使用变量
%foo%

# 局部变量
setlocal
endlocal
```

## 使用数学表达式

```shell
set /a foo=1+1
```

## 命令行选择语句

```shell
if [not] condition (statment1) else (statment2)
# 条件
if foo==1
if errorlevel 0
if defined foo

# 比较忽略大小写
if /i "%foo%"=="%bar%"
```

**使用比较运算符：**

| 运算符 | 描述                                                         |
| ------ | ------------------------------------------------------------ |
| equ    | 检查两个值是否相等，如果相等，则结果为真                     |
| neq    | 检查两个值是否不相等，如果不相等，则结果为真                 |
| Iss    | 检查两个值之间的小于关系，如果值1小于值2，则结果为真         |
| leq    | 检查两个值之间的小于等于关系，如果值1小于等于值2，则结果为真 |
| gtr    | 检查两个值之间的大于关系，如果值1大于值2，则结果为真         |
| geq    | 检查两个值之间的大于等于关系，如果值1大于等于值2,则结果为真  |

## 命令行迭代语句

```shell
# iterator 中的变量大小写敏感，只能用%%a-z,%%A-Z
for iterator do (statment)
```

> 交互模式下用 `%a`

**迭代的不同形式：**

| 迭代用途                         | 语法格式                                                 |
| -------------------------------- | -------------------------------------------------------- |
| 文件集合                         | `for %%variable in (fleSet) do statement`                |
| 目录集合                         | `for /D %%variable in (directorySet) do statement`       |
| 子目录中的文件                   | `for /R [path] %%variable in (fileSet) do statement`     |
| 遍历一系列的值                   | `for /L %%variable in (stepRange) do statement`          |
| 分析文本文件、字符串以及命令输出 | `for /F ["options"] %%variable in (source) do statement` |

### 遍历一系列值

```shell
for /L %%variab1e in (start,step,end) do (statement)
```

### 在成组的文件中迭代执行

```shell
for %%variable in (fileSet) do (statement)
```

- 可以使用通配符，如 `*.txt`
- 可以指定多个，空格分隔，如 `*txt *.doc`

### 在目录中迭代执行

```shell
for /d %%variable in (di rectorySet) do (statement)
# 列出 C 盘所有根目录
for /d %%d in (C:\*) do (echo %%d)
# /r 递归，默认当前目录
for /r C:\foo /d %%d in (*) do (echo %%d)
```

### 分析文件的内容与输出

```shell
for /F "options" %%variable in (source) do statement
```

**用于文件内容与命令输出信息分析的选项：**

| 选项     | 选项描述                                                     | 示例                  | 示例描述                                                     |
| -------- | ------------------------------------------------------------ | --------------------- | ------------------------------------------------------------ |
| eol      | 设置行尾注释字符，行尾注释字符后的所有数据都被命令shell看成注释 | eol=#                 | 将#设置为行尾注释字符                                        |
| skip     | 设置文件起始处跳过的行数                                     | skip=5                | 通知命令shell跳过源文件中的1到5行                            |
| delims   | 设置各字段之间的分隔符，默认情况下为制.表符或空格            | delims=,.;            | 指定逗号、句点、分号为分隔符                                 |
| tokens   | 为每一源行设置令牌字段,如果以a或A作为起始的迭代变量，则至多可以指定26个令牌。默认情况下，只对第一个令牌进行检查 | tokens=1,3；tokens=2-5；tokens=* | 第一个实例将令牌字段设置为使用1与3,第二个实例将令牌字段设置为使用2、3、4、5,第三个不分割 |
| usebackq | 规定可以在源指定符中使用引号：对文件名使用双引号，对命令使用反引号，对字符串使用单引号 | usebackq              | 激活该选项                                                   |

> `usebackq` 是指 source 的解析方式，默认不加双引号是文件，加双引号是字符串，开启 `usebackq` 加双引号是文件，反引号是命令，如：
>
> ```shell
> for /f "tokens=1-2 usebackq" %%a in (`echo hehe haha`) do (echo %%a %%b)
> ```

## 创建子程序与过程

```shell
goto EXIT
:EXIT

# 不用 call 执行 sub.bat 后不会回来
call sub.bat
# 传递变量
call sub.bat arg1
```

